# webpack 中的插件

## 一、介绍

## 二、`html-webpack-plugin`

### 2.1 介绍

[html-webpack-plugin](https://github.com/jantimon/html-webpack-plugin) 是 webpack 生态系统中一个非常重要的插件。下面是该插件的主要作用。

- 如果项目中不存在入口 HTML（`index.html`）文件，则自动创建该文件；如果存在入口文件，可以以该文件为模板，创建一个新的入口文件。
- 将项目打包后的各种资源，注入到入口文件中。
- 压缩 HTML 代码。

下面列出了该插件常见的配置项。

- `template`：指定 HTML 模板文件路径。这是最核心的配置项。
- `filename`：指定生成的 HTML 文件名，支持占位符。默认值为 `'index.html'`。
- `inject`：控制资源注入的位置和方式。可选值为布尔值、`'head'` 和 `'body'`。如果指定为 `'head'`，则注入到 `<head>` 标签中，默认值为 `true`。
- `title`：设置 HTML 页面的标题。这个值会替换模板中的 `<%= htmlWebpackPlugin.options.title %>`。
- `templateParameters`：对象类型。向模板传递自定义参数。可以在模板中使用这些参数。比如，`<title><%= appName %> v<%= version %></title>`。
- `hash`：控制是否使用文件名哈希。当设置为 `true` 时，插件会在资源文件名后添加哈希值，用于缓存破坏。
- `minify`：压缩选项。生产环境中的重要配置，可通过该配置项指定具体的压缩行为。
- `chunks`：控制哪些 chunk 会被注入到 HTML 中，默认注入所有的 chunk。
- `favicon`：设置网站的 favicon 图标。
- `meta`：用于添加 `<meta>` 标签。

  比如，如果指定为下面的配置。

  ```javascript
  meta: {
    viewport: 'width=device-width, initial-scale=1, shrink-to-fit=no'
  }
  ```

  会创建一个这样的 meta 标签。

  ```html
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  ```

### 2.2 自定义压缩行为

`minify` 配置项控制压缩 HTML 代码的具体行为。生产模式下，默认值为 `true`，此时，webpack 使用内置的 [html-minifier-terser](https://github.com/DanielRuf/html-minifier-terser)插件，压缩 HTML 代码。也就是说，`minify` 配置项其实是对 `html-minifier-terser` 插件进行配置。其他模式下值为 `false`，表示不开启压缩。

下面是 `minify` 配置项的默认值。

```javascript
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  plugins: [
    new HtmlWebpackPlugin({
      minify: {
        // 默认值
        collapseWhitespace: true, // 移除空白符
        removeComments: true, // 移除 HTML 注释
        keepClosingSlash: false, // 移除自闭合标签的斜杠
        removeRedundantAttributes: true, // 移除冗余属性
        removeScriptTypeAttributes: true, // 移除 script 的 type 属性
        removeStyleLinkTypeAttributes: true, // 移除 style 和 link 的 type 属性
        useShortDoctype: true, // 使用短文档类型
      },
    }),
  ],
};
```

除了上面的默认属性，还可以考虑配置下面的几个属性。

- `minifyJS: true`：压缩内联 JavaScript。
- `minifyCSS: true`：压缩内联 CSS。
- `minifyURLs: true`：压缩 URL。
- `removeEmptyElements: true`：移除空元素。
- `removeEmptyAttributes: true`：移除空属性。
- `collapseBooleanAttributes: true`：压缩布尔属性。

### 2.3 变量注入

`html-webpack-plugin` 提供了强大的变量注入功能，允许在 HTML 模板中使用各种 webpack 和插件提供的变量。这些变量可以帮助我们动态生成HTML内容，实现更灵活的模板配置。

`htmlWebpackPlugin.options` 对象包含了传递给 `HtmlWebpackPlugin` 的所有配置选项。

`htmlWebpackPlugin.files` 对象包含了 webpack 打包后的文件信息。通过这个对象，可以获取所有需要被注入的样式、脚本和 chunks 数组。

```html
<!-- 注入所有 CSS 文件 -->
<% htmlWebpackPlugin.files.css.forEach(function(cssFile) { %>
  <link href="<%= cssFile %>" rel="stylesheet">
<% }); %>

<!-- 注入所有 JS 文件 -->
<% htmlWebpackPlugin.files.js.forEach(function(jsFile) { %>
  <script src="<%= jsFile %>"></script>
<% }); %>

<!-- 遍历所有 chunks -->
<% Object.keys(htmlWebpackPlugin.files.chunks).forEach(function(chunkName) { %>
  <% var chunk = htmlWebpackPlugin.files.chunks[chunkName]; %>
  <% if (chunk.css) { %>
    <% chunk.css.forEach(function(cssFile) { %>
      <link href="<%= cssFile %>" rel="stylesheet">
    <% }); %>
  <% } %>
  <% if (chunk.js) { %>
    <% chunk.js.forEach(function(jsFile) { %>
      <script src="<%= jsFile %>"></script>
    <% }); %>
  <% } %>
<% }); %>
```

通过 `templateParameters` 属性，可以注入自定义变量到模板中。

```javascript
// webpack.config.js
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  plugins: [
    new HtmlWebpackPlugin({
      templateParameters: {
        // 应用信息
        appName: 'React应用',
        version: '1.0.0',
        environment: process.env.NODE_ENV || 'development',
        
        // 配置信息
        cdnUrl: process.env.CDN_URL || 'https://cdn.example.com',
        
        // 功能开关
        enableAnalytics: process.env.NODE_ENV === 'production',
        enableDebug: process.env.NODE_ENV === 'development',
        
        // 自定义函数
        formatDate: function(date) {
          return new Date(date).toLocaleDateString();
        },
        
        // 复杂对象
        config: {
          theme: 'light',
          language: 'zh-CN',
          features: ['feature1', 'feature2'],
        },
      },
    }),
  ],
};
```

```html
<!-- public/index.html -->
<!DOCTYPE html>
<html lang="<%= config.language %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= appName %> v<%= version %></title>
  
  <!-- 应用信息 -->
  <meta name="app-name" content="<%= appName %>">
  <meta name="version" content="<%= version %>">
  <meta name="environment" content="<%= environment %>">
  
  <!-- 配置信息 -->
  <meta name="cdn-url" content="<%= cdnUrl %>">

  <!-- 使用条件渲染避免不必要的代码 -->
  <% if (environment === 'production') { %>
    <!-- 生产环境特定代码 -->
    <meta name="robots" content="index, follow">
    <script src="https://analytics.example.com/tracker.js"></script>
  <% } else { %>
    <!-- 开发环境特定代码 -->
    <meta name="robots" content="noindex, nofollow">
    <script>
      console.log('开发模式已启用');
    </script>
  <% } %>
    
  <!-- 条件渲染 -->
  <% if (enableAnalytics) { %>
    <script>
      // 生产环境分析代码
      window.analytics = {
        enabled: true,
        track: function(event) {
          console.log('Analytics:', event);
        }
      };
    </script>
  <% } %>
  
  <% if (enableDebug) { %>
    <script>
      // 开发环境调试代码
      window.debug = {
        enabled: true,
        log: function(message) {
          console.log('Debug:', message);
        }
      };
    </script>
  <% } %>
  
  <!-- 主题配置 -->
  <script>
    window.appConfig = {
      theme: '<%= config.theme %>',
      language: '<%= config.language %>',
      features: <%- JSON.stringify(config.features) %>,
    };
  </script>
</head>
<body>
  <div style="display: none;">
    <p>应用名称: <%= appName %></p>
    <p>版本: <%= version %></p>
    <p>环境: <%= environment %></p>
  </div>
</body>
</html>
```

### 2.4 模板优化

这部分内容，在 [模板优化](/2025/react/2025-08-04-optimization.md) 有详细介绍。

[示例代码](/examples/webpack/demos/html-optimization/)
