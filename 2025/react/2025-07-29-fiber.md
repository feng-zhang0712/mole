# Fiber

## Fiber 结构

```typescript
export type Fiber = {
  // 标识属性
  tag: WorkTag,
  key: null | string,
  elementType: any,
  type: any,
  stateNode: any,

  // 树结构属性
  return: Fiber | null,
  child: Fiber | null,
  sibling: Fiber | null,
  index: number,

  // 引用属性
  ref:
    | null
    | (((handle: mixed) => void) & {_stringRef: ?string, ...})
    | RefObject,
  refCleanup: null | (() => void),

  // 属性相关
  pendingProps: any,
  memoizedProps: any,

  // 状态管理
  updateQueue: mixed,
  memoizedState: any,

  // 依赖管理
  dependencies: Dependencies | null,

  // 模式与标志
  mode: TypeOfMode,
  flags: Flags,
  subtreeFlags: Flags,
  deletions: Array<Fiber> | null,

  // 优先级管理
  lanes: Lanes,
  childLanes: Lanes,

  // 双缓冲
  alternate: Fiber | null,

  // 性能监控
  actualDuration?: number,
  actualStartTime?: number,
  selfBaseDuration?: number,
  treeBaseDuration?: number,
};
```

对于 Fiber 结构，不同的属性，有不同的应用场景。下面，分别对他们进行介绍。

### 标识属性

#### `tag`

`tag: WorkTag` 字段是一个数值类型，用于指定 Fiber 节点的类型。在 React 的调和算法中，它决定了 React 如何处理和更新特定的 Fiber。

React 定义了几十种不同的 Tag，每种类型代表着不同的元素。

下面列出了几种常见的 `tag` 类型。

- `const FunctionComponent = 0`：表示 function 组件。
- `const ClassComponent = 1`：表示 class 组件。
- `const HostRoot = 3`：表示根节点。
- `const HostComponent = 5`：表示原生 DOM 元素，比如 `div`、`p` 等。
- `const HostText = 6`：文本节点。

#### `key`

`key: null | string` 字段表示元素中的键，在 React 的 diff 算法，优化列表渲染。在组件渲染方法中渲染列表组件时，应该总是为循环中最外层的元素，提供一个稳定且唯一的 `key`。

#### `elementType`

`elementType: any` 字段是一个 Symbol 类型，用于指定 Fiber 对应的组件或元素的类型。

React 定义了几十种元素类型，`ReactElement` 对象中的 `$$typeof` 字段，就指向这些类型。

```javascript
export const REACT_LEGACY_ELEMENT_TYPE: symbol = Symbol.for('react.element');
export const REACT_ELEMENT_TYPE: symbol = renameElementSymbol
  ? Symbol.for('react.transitional.element')
  : REACT_LEGACY_ELEMENT_TYPE;
export const REACT_PORTAL_TYPE: symbol = Symbol.for('react.portal');
export const REACT_FRAGMENT_TYPE: symbol = Symbol.for('react.fragment');
export const REACT_CONTEXT_TYPE: symbol = Symbol.for('react.context');
// ...
```

#### `type`

`type: any` 字段用于指定组件或者元素的类型。该字段对应于 `jsx` 模块中 `createElement(type, config, children)` 方法的 `type` 参数。对于 class 或者 function 组件，`type` 字段是组件的名称，对于原生的 HTML 元素，`type` 字段是元素的名称，比如，`div`、`span` 等。

#### `stateNode`

`stateNode: any` 字段保存着 Fiber 节点所代表的组件或 DOM 元素的实例引用。该字段是连接 React 虚拟 DOM 和实际 DOM 的重要桥梁。对于 class 组件，它指向类组件的实例。对于 host 组件，它指向浏览器创建的相应的 DOM 元素。

下面列出了不同类型 Fiber 的 stateNode 值。

- `null`：FunctionComponent 没有实例，所以为 `null`。
- `MyComponentInstance`：表示 ClassComponent 的实例。比如 `class MyComponent extends React.Component`。
- `HTMLDivElement`：表示实际的 DOM 元素实例。比如 `<div>Hello</div>`。
- `Text`：表示文本节点实例。比如 `"Hello World"`。
- `FiberRoot`：表示 FiberRoot 实例。比如 ReactDOM.render 的根节点。

### 树结构属性

#### `return`

`return: Fiber | null` 字段指向当前 Fiber 节点的父节点，用于构建从子节点到父节点的向上链接。

#### `child`

`child: Fiber | null` 字段指向当前 Fiber 节点的第一个子节点，用于构建从父节点到子节点的向下链接。该字段主要用于深度优先遍历和查找特定类型的子节点。

#### `sibling`

`sibling: Fiber | null` 字段指向当前 Fiber 节点的下一个兄弟节点，用于构建同级节点之间的横向链接。该字段主要用于同级节点遍历和列表渲染优化。

#### `index`

`index: number` 字段表示当前 Fiber 节点在其父节点的子节点列表中的索引位置。

### 引用属性

#### `ref`

`ref` 字段存储对组件实例或 DOM 元素的引用，支持函数式 `ref` 和对象式 `ref`。

#### `refCleanup`

`refCleanup: null | (() => void)` 字段存储清理 `ref` 的函数，用于在组件卸载或 `ref` 变化时进行清理工作。

### 属性相关

#### `pendingProps`

`pendingProps: any` 字段存储当前 Fiber 节点**待处理的新属性**。这些属性来自父组件传递的 props，但尚未被应用到组件实例上。这个属性一般在 render 阶段被设置，并在 commit 阶段被应用。

#### `memoizedProps`

`memoizedProps: any` 字段存储当前 Fiber 节点已经处理过的属性。这些属性已经被应用到组件实例上，并用于与新的 `pendingProps` 进行比较。

这个属性来自上一次渲染的 `pendingProps`，表示当前组件实例正在使用的属性。在 commit 阶段，`pendingProps` 会被复制到 `memoizedProps`。在某些场景下很重要，比如用于 props 的浅比较，判断是否需要更新。

### 状态管理

#### `updateQueue`

`updateQueue: mixed` 字段存储当前 Fiber 节点的更新队列，这个队列包含了所有待处理的状态更新、副作用和其他需要执行的更新操作。该字段在 render 阶段被处理，在 commit 阶段被执行。

`updateQueue` 是一个通用类型，指向两种不同的队列，具体使用哪种队列类型取决于Fiber节点的类型。对于 Class 组件，指向 Class 组件的 `UpdateQueue`；对于 Function 组件， 指向 Hooks 的 `UpdateQueue`。

两种队列都实现了React的双缓冲机制，并且也都支持 React 的并发特性。

（1）Class 组件的 Update 结构

```typescript
export type Update<State> = {
  lane: Lane,
  tag: 0 | 1 | 2 | 3,
  payload: any,
  callback: (() => mixed) | null,
  next: Update<State> | null,
};
```

- `lane`：表示更新的优先级，用于 React 的并发特性。
- `更新类型标识符`：`0` 表示普通更新，`1` 表示替换更新，`2` 表示强制更新，`3` 表示捕获错误更新。
- `payload`：更新的具体数据，可以是函数或值。
- `callback`：更新完成后的回调函数，用于副作用处理。
- `next`：链表结构，指向队列中的下一个更新。

```typescript
export type SharedQueue<State> = {
  pending: Update<State> | null,
  lanes: Lanes,
  hiddenCallbacks: Array<() => mixed> | null, 
};
```

- `pending`：指向待处理更新队列的指针，形成单向链表。
- `lanes`：当前队列中所有更新涉及的车道（优先级）集合。
- `hiddenCallbacks`：存储被隐藏的回调函数，用于特殊情况下的副作用处理。

```typescript
export type UpdateQueue<State> = {
  baseState: State,
  firstBaseUpdate: Update<State> | null,
  lastBaseUpdate: Update<State> | null,
  shared: SharedQueue<State>,
  callbacks: Array<() => mixed> | null,
};
```

- `baseState`：表示应用第一个更新之前的状态，用于状态重建。
- `firstBaseUpdate`：指向第一个尚未处理的基础更新的指针。
- `lastBaseUpdate`：指向最后一个基础更新的指针，用于快速添加新更新。
- `shared`：共享队列，包含当前和 work-in-progress 的更新信息。
- `callbacks`：存储所有更新完成后的回调函数。

（2）Hooks 的 Update 结构

```typescript
export type Update<S, A> = {
  lane: Lane,
  revertLane: Lane,
  action: A,
  hasEagerState: boolean,
  eagerState: S | null,
  next: Update<S, A>,
};
```

- `lane`：与 Class 组件相同，表示更新优先级。
- `revertLane`：用于并发特性中的状态回滚，当高优先级更新被中断时使用。
- `action`：dispatch函数接收的参数，可以是值或函数。
- `hasEagerState`：标识是否已经预计算了状态值。
- `eagerState`：预计算的状态值，用于性能优化。
- `next`：链表结构，指向下一个更新。

```typescript
export type UpdateQueue<S, A> = {
  pending: Update<S, A> | null,
  lanes: Lanes,
  dispatch: (A => mixed) | null,
  lastRenderedReducer: ((S, A) => S) | null,
  lastRenderedState: S | null,
};
```

- `pending`：指向待处理更新队列的指针。
- `lanes`：当前队列中所有更新涉及的车道（优先级）集合。
- `dispatch`：用于触发更新的 dispatch 函数。
- `lastRenderedReducer`：最后使用的 reducer 函数，用于状态计算。
- `lastRenderedState`：最后渲染的状态值，用于状态比较和优化。

从上面的属性分析可以看出，两种 Update 都使用链表结构存储更新，这种设计的优势是，支持 `O(1)` 的插入操作，便于遍历和处理更新，以及支持并发渲染时的状态管理。

通过 lane 系统实现细粒度的优先级控制。不同更新可以有不同的优先级，支持高优先级更新抢占低优先级更新，并且支持批量处理和状态重建。

#### `memoizedState`

`memoizedState: any` 字段存储当前 Fiber 节点的已处理状态。这个状态是组件当前正在使用的状态，用于渲染和计算。

### 依赖管理

#### `dependencies`

`dependencies: Dependencies | null` 字段存储当前 Fiber 节点的依赖关系。主要用于 Context 和 Hooks 的依赖管理，确保在依赖变化时能够正确更新。此属性会在 render 阶段被设置和更新。

### 模式与标志

#### `mode`

`mode: TypeOfMode` 字段指定当前 Fiber 节点的渲染模式，控制 React 的渲染行为和优先级处理策略。

下面列出了几种常见的渲染模式。

- `NoMode`：同步模式。
- `ConcurrentMode`：并发模式。
- `ProfileMode`：性能分析模式。
- `StrictLegacyMode`：严格模式。

#### `flags`

`flags: Flags` 字段存储当前 Fiber 节点的副作用标记，用于标识需要执行的特定操作。该字段在 commit 阶段被处理。

下面列出了几种常见的标识类型。

- `NoFlags`：无副作用。
- `PerformedWork`：已执行工作。
- `Placement`：插入。
- `Update`：更新。
- `ChildDeletion`：子节点删除。
- `ForceUpdateForLegacySuspense`：强制更新。
- `DidCapture`：错误捕获。
- `Hydrating`：水合。

#### `subtreeFlags`

`subtreeFlags: Flags` 字段存储当前 Fiber 节点及其所有子节点的副作用标记的汇总，用于快速判断子树是否需要处理。该字段可用于跳过不需要处理的子树。

```javascript
// 子树标志的计算
subtreeFlags = flags | child.subtreeFlags | sibling.subtreeFlags
```

#### `deletions`

`deletions: Array<Fiber> | null` 字段存储需要删除的 Fiber 节点列表，用于批量处理删除操作。该字段主要是为了避免逐个删除带来的性能问题。

### 优先级管理

#### `lanes: Lanes`

`lanes` 字段存储当前 Fiber 节点的优先级信息，用于并发模式下的优先级调度。

下面列出了几个常见的优先级。

- `NoLanes ｜ NoLanes`：无优先级。
- `SyncLane`：同步优先级。
- `InputContinuousLane`：输入连续优先级。
- `DefaultLane`：默认优先级。
- `IdleLane`：空闲优先级。
- `OffscreenLane`：离屏优先级。

#### `childLanes: Lanes`

`childLanes` 字段存储当前 Fiber 节点的所有子节点的优先级信息的汇总。可用于快速判断子树是否有高优先级更新。

```javascript
// 子节点优先级的计算
childLanes = child.lanes | child.childLanes | sibling.lanes | sibling.childLanes
```

### 双缓冲

#### `alternate: Fiber | null`

`alternate` 字段存储当前 Fiber 节点的备用副本，用于**双缓冲**机制。该字段主要是为了避免创建和销毁 Fiber 节点的开销。

```javascript
// 双缓冲的工作原理
// current 树：当前显示在屏幕上的树
// workInProgress 树：正在构建的新树
// alternate 连接两个树，实现无缝切换
```

React 使用双缓冲机制确保状态更新的原子性。当前队列保持不变，确保渲染的稳定性，工作队列可以安全地修改和实验，只有在提交阶段才交换两个队列。

