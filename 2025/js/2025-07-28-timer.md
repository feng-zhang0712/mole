# 定时器

## Web API 中的定时器

### setTimeout

### setInterval

## 替代方案

### MessageChannel

MessageChannel API 是原生提供的一种用于一对一的通信机制，通过执行 `MessageChannel` 构造函数生成的两个 port，可以实现不同上下文之间的通信。这个 API 也可以用来模式实现 `setTimeout`，而且相比于后者，MessageChannel API 有很多优点。

- MessageChannel 同样能够实现异步操作。
- MessageChannel 没有 `setTimeout` 的最低延迟。
- 某些情况下，`setTimeout` 的执行时机可能变得难以预测。比如，当设备处于后台或者低电量模式时，`setTimeout` 可能会被浏览器节流，而 MessageChannel 不会有这个问题。

```javascript
let enqueueTask;

if (typeof MessageChannel !== 'undefined') {
  enqueueTask = function (callback) {
    const channel = new MessageChannel();
    channel.port1.onmessage = function () {
      channel.port1.close();
      callback();
    }
    channel.port2.postMessage(undefined);
  }
}

if (enqueueTask) {
  enqueueTask(() => {
    console.log('in enqueueTask');
  });
}

console.log('start');

// start
// in enqueueTask
```

使用 `MessageChannel` 执行异步操作，实际上也是执行的宏任务，它的优先级要低于微任务。

React 中对 `setTimeout` 的模拟，就是通过上面的代码实现的。

## 参考

- [react 源码](https://github.com/facebook/react/blob/cc015840ef72d48de86778785894c7ca44f4f856/packages/scheduler/src/forks/Scheduler.js#L532)
