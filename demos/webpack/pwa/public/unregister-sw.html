<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Worker 注销工具</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }

    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }

    .button:hover {
      background: #0056b3;
    }

    .danger {
      background: #dc3545;
    }

    .danger:hover {
      background: #c82333;
    }

    .status {
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body>
  <h1>🔧 Service Worker 管理工具</h1>

  <div id="status" class="status warning">正在检查 Service Worker 状态...</div>

  <div>
    <button class="button" onclick="checkSW()">🔄 检查状态</button>
    <button class="button danger" onclick="unregisterSW()">🗑️ 注销所有 Service Worker</button>
    <button class="button" onclick="clearCache()">🧹 清除缓存</button>
  </div>

  <div id="registrations"></div>

  <script>
    async function checkSW() {
      const statusDiv = document.getElementById('status');
      const registrationsDiv = document.getElementById('registrations');

      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          statusDiv.textContent = `找到 ${registrations.length} 个 Service Worker 注册`;
          statusDiv.className = 'status success';

          registrationsDiv.innerHTML = '<h3>已注册的 Service Worker:</h3>';
          registrations.forEach((registration, index) => {
            registrationsDiv.innerHTML += `
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px;">
                    <strong>注册 ${index + 1}:</strong><br>
                    <strong>Scope:</strong> ${registration.scope}<br>
                    <strong>Active:</strong> ${registration.active ? '是' : '否'}<br>
                    <strong>Installing:</strong> ${registration.installing ? '是' : '否'}<br>
                    <strong>Waiting:</strong> ${registration.waiting ? '是' : '否'}<br>
                    <button class="button danger" onclick="unregisterSpecific('${registration.scope}')">注销此 Service Worker</button>
                </div>
            `;
          });
        } catch (error) {
          statusDiv.textContent = `检查失败: ${error.message}`;
          statusDiv.className = 'status error';
        }
      } else {
        statusDiv.textContent = '浏览器不支持 Service Worker';
        statusDiv.className = 'status warning';
      }
    }

    async function unregisterSW() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            await registration.unregister();
          }
          document.getElementById('status').textContent = `已注销 ${registrations.length} 个 Service Worker`;
          document.getElementById('status').className = 'status success';
          document.getElementById('registrations').innerHTML = '';
        } catch (error) {
          document.getElementById('status').textContent = `注销失败: ${error.message}`;
          document.getElementById('status').className = 'status error';
        }
      }
    }

    async function unregisterSpecific(scope) {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          const registration = registrations.find(r => r.scope === scope);
          if (registration) {
            await registration.unregister();
            document.getElementById('status').textContent = `已注销 Service Worker: ${scope}`;
            document.getElementById('status').className = 'status success';
            checkSW(); // 重新检查状态
          }
        } catch (error) {
          document.getElementById('status').textContent = `注销失败: ${error.message}`;
          document.getElementById('status').className = 'status error';
        }
      }
    }

    async function clearCache() {
      try {
        const cacheNames = await caches.keys();
        for (const cacheName of cacheNames) {
          await caches.delete(cacheName);
        }
        document.getElementById('status').textContent = `已清除 ${cacheNames.length} 个缓存`;
        document.getElementById('status').className = 'status success';
      } catch (error) {
        document.getElementById('status').textContent = `清除缓存失败: ${error.message}`;
        document.getElementById('status').className = 'status error';
      }
    }

    // 页面加载时自动检查
    window.addEventListener('load', checkSW);
  </script>
</body>

</html>