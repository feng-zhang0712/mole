<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Worker æ³¨é”€å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }

    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }

    .button:hover {
      background: #0056b3;
    }

    .danger {
      background: #dc3545;
    }

    .danger:hover {
      background: #c82333;
    }

    .status {
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body>
  <h1>ğŸ”§ Service Worker ç®¡ç†å·¥å…·</h1>

  <div id="status" class="status warning">æ­£åœ¨æ£€æŸ¥ Service Worker çŠ¶æ€...</div>

  <div>
    <button class="button" onclick="checkSW()">ğŸ”„ æ£€æŸ¥çŠ¶æ€</button>
    <button class="button danger" onclick="unregisterSW()">ğŸ—‘ï¸ æ³¨é”€æ‰€æœ‰ Service Worker</button>
    <button class="button" onclick="clearCache()">ğŸ§¹ æ¸…é™¤ç¼“å­˜</button>
  </div>

  <div id="registrations"></div>

  <script>
    async function checkSW() {
      const statusDiv = document.getElementById('status');
      const registrationsDiv = document.getElementById('registrations');

      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          statusDiv.textContent = `æ‰¾åˆ° ${registrations.length} ä¸ª Service Worker æ³¨å†Œ`;
          statusDiv.className = 'status success';

          registrationsDiv.innerHTML = '<h3>å·²æ³¨å†Œçš„ Service Worker:</h3>';
          registrations.forEach((registration, index) => {
            registrationsDiv.innerHTML += `
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px;">
                    <strong>æ³¨å†Œ ${index + 1}:</strong><br>
                    <strong>Scope:</strong> ${registration.scope}<br>
                    <strong>Active:</strong> ${registration.active ? 'æ˜¯' : 'å¦'}<br>
                    <strong>Installing:</strong> ${registration.installing ? 'æ˜¯' : 'å¦'}<br>
                    <strong>Waiting:</strong> ${registration.waiting ? 'æ˜¯' : 'å¦'}<br>
                    <button class="button danger" onclick="unregisterSpecific('${registration.scope}')">æ³¨é”€æ­¤ Service Worker</button>
                </div>
            `;
          });
        } catch (error) {
          statusDiv.textContent = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
          statusDiv.className = 'status error';
        }
      } else {
        statusDiv.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒ Service Worker';
        statusDiv.className = 'status warning';
      }
    }

    async function unregisterSW() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            await registration.unregister();
          }
          document.getElementById('status').textContent = `å·²æ³¨é”€ ${registrations.length} ä¸ª Service Worker`;
          document.getElementById('status').className = 'status success';
          document.getElementById('registrations').innerHTML = '';
        } catch (error) {
          document.getElementById('status').textContent = `æ³¨é”€å¤±è´¥: ${error.message}`;
          document.getElementById('status').className = 'status error';
        }
      }
    }

    async function unregisterSpecific(scope) {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          const registration = registrations.find(r => r.scope === scope);
          if (registration) {
            await registration.unregister();
            document.getElementById('status').textContent = `å·²æ³¨é”€ Service Worker: ${scope}`;
            document.getElementById('status').className = 'status success';
            checkSW(); // é‡æ–°æ£€æŸ¥çŠ¶æ€
          }
        } catch (error) {
          document.getElementById('status').textContent = `æ³¨é”€å¤±è´¥: ${error.message}`;
          document.getElementById('status').className = 'status error';
        }
      }
    }

    async function clearCache() {
      try {
        const cacheNames = await caches.keys();
        for (const cacheName of cacheNames) {
          await caches.delete(cacheName);
        }
        document.getElementById('status').textContent = `å·²æ¸…é™¤ ${cacheNames.length} ä¸ªç¼“å­˜`;
        document.getElementById('status').className = 'status success';
      } catch (error) {
        document.getElementById('status').textContent = `æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`;
        document.getElementById('status').className = 'status error';
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', checkSW);
  </script>
</body>

</html>