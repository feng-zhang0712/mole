# React大文件上传演示项目

这是一个演示React前端开发中大文件上传功能的完整项目，**完全实现了断点续传功能**，解决了大文件上传的所有关键问题。

## 🎯 核心功能特性

### ✅ 已实现的完整功能

1. **文件分片上传（Chunk Upload）**
   - 自动将大文件分割成2MB的块
   - 支持并发上传多个块
   - 可配置分片大小

2. **断点续传（Resume Upload）** ⭐ **核心功能**
   - **前端进度持久化**: 使用localStorage保存上传进度
   - **服务器端进度保存**: 服务器重启后不丢失上传状态
   - **网络状态检测**: 自动检测在线/离线状态
   - **智能暂停恢复**: 网络断开时自动暂停，恢复后继续
   - **文件完整性验证**: 通过文件大小和修改时间验证文件一致性
   - **进度过期管理**: 24小时后自动清理过期进度

3. **文件完整性验证**
   - 计算文件哈希值（简化版本）
   - 上传完成后验证文件完整性
   - 防止文件损坏或传输错误

4. **上传进度监控**
   - 实时显示上传进度条
   - 显示当前上传速度和剩余时间
   - 支持暂停/恢复状态显示

5. **并发控制**
   - 支持同时上传多个文件
   - 控制单个文件的并发分片数
   - 避免服务器压力过大

6. **错误处理和重试机制**
   - 网络异常时的自动重试（最多3次）
   - 失败分片的重新上传
   - 用户友好的错误提示
   - 智能错误分类（网络错误、文件错误等）

7. **内存管理**
   - 避免大文件在内存中完整加载
   - 使用分片读取和流式处理
   - 及时释放不需要的内存

8. **用户体验优化**
   - 拖拽上传支持
   - 文件类型和大小限制
   - 上传队列管理
   - 网络状态指示器

9. **安全性考虑**
   - 文件类型白名单验证
   - 文件大小限制
   - 防止恶意文件上传

10. **服务器端配合**
    - 支持分片上传的RESTful API
    - 分片合并和存储策略
    - 临时文件清理机制
    - 上传进度持久化存储

## 🔄 断点续传功能详解

### 工作原理

1. **进度保存**
   - 前端：localStorage保存上传进度、文件信息、时间戳
   - 后端：JSON文件保存服务器端上传状态
   - 双重保障，确保进度不丢失

2. **网络状态检测**
   - 监听`online`/`offline`事件
   - 网络断开时自动暂停上传
   - 网络恢复后自动尝试恢复

3. **智能恢复机制**
   - 验证文件一致性（大小、修改时间）
   - 检查进度是否过期（24小时）
   - 合并前端和服务器端进度
   - 从断点处继续上传

4. **状态管理**
   - `pending`: 等待中
   - `uploading`: 上传中
   - `paused`: 已暂停（网络断开）
   - `completed`: 已完成
   - `error`: 上传失败

### 断点续传流程

```
选择文件 → 检查本地进度 → 检查服务器进度 → 合并进度 → 继续上传
    ↓
网络断开 → 自动暂停 → 保存进度 → 等待网络恢复
    ↓
网络恢复 → 检测进度 → 验证文件 → 继续上传 → 完成
```

## 🏗️ 技术架构

- **前端**: React 18 + JSX + ESM模块
- **构建工具**: Webpack 5 + Babel
- **后端**: Node.js + Express
- **文件处理**: Multer + fs-extra
- **模块系统**: ES Modules (ESM)
- **状态管理**: React Hooks + localStorage
- **网络检测**: Navigator API

## 📁 项目结构

```
file-upload/
├── public/
│   └── index.html              # HTML模板
├── src/
│   ├── components/
│   │   ├── FileUploader.jsx    # 文件上传组件（支持拖拽）
│   │   └── UploadList.jsx      # 上传列表组件（支持暂停/恢复）
│   ├── utils/
│   │   └── uploadService.js    # 上传服务工具（断点续传核心）
│   ├── App.jsx                 # 主应用组件（网络状态管理）
│   └── index.js                # 应用入口
├── server/
│   └── index.js                # Express服务器（进度持久化）
├── package.json                 # 项目依赖
├── webpack.config.js            # Webpack配置
├── test-resume.js              # 断点续传功能测试脚本
└── README.md                    # 项目说明
```

## 🚀 安装和运行

### 1. 安装依赖

```bash
npm install
```

### 2. 启动开发服务器

```bash
# 同时启动前端和后端
npm run dev

# 或者分别启动
npm run server    # 后端服务器 (端口5001)
npm run client    # 前端开发服务器 (端口3000)
```

### 3. 测试断点续传功能

```bash
# 运行断点续传测试脚本
node test-resume.js

# 或者直接启动项目测试
npm run dev
```

### 4. 构建生产版本

```bash
npm run build
```

## 🧪 断点续传测试方法

### 方法1：模拟网络断开
1. 开始上传大文件
2. 在浏览器开发者工具中切换到"Offline"模式
3. 观察上传自动暂停
4. 切换回"Online"模式
5. 点击"恢复上传"按钮

### 方法2：关闭服务器
1. 开始上传大文件
2. 按Ctrl+C关闭服务器
3. 重新启动服务器：`npm run server`
4. 刷新页面，选择相同文件
5. 观察上传从断点继续

### 方法3：刷新页面
1. 开始上传大文件
2. 刷新浏览器页面
3. 重新选择相同文件
4. 观察上传进度恢复

## 📊 API接口

### 文件上传相关

- `POST /api/upload/check` - 检查文件是否已存在
- `POST /api/upload/chunk` - 上传文件块
- `POST /api/upload/merge` - 合并文件块

### 进度管理相关

- `GET /api/upload/progress` - 获取当前上传进度
- `GET /api/upload/files` - 获取已上传文件列表

### 系统相关

- `GET /api/health` - 健康检查

## ⚙️ 配置说明

### 分片大小
在 `src/utils/uploadService.js` 中修改：
```javascript
const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
```

### 重试配置
```javascript
const MAX_RETRIES = 3;        // 最大重试次数
const RETRY_DELAY = 1000;     // 重试延迟（毫秒）
```

### 进度过期时间
```javascript
const EXPIRY_TIME = 24 * 60 * 60 * 1000; // 24小时
```

### 服务器端口
在 `server/index.js` 中修改：
```javascript
const PORT = process.env.PORT || 5001;
```

## 🔍 断点续传实现细节

### 前端实现
- **进度持久化**: localStorage存储上传状态
- **网络检测**: 监听online/offline事件
- **智能恢复**: 验证文件一致性后继续上传
- **状态管理**: 完整的暂停/恢复状态处理

### 后端实现
- **进度保存**: JSON文件持久化上传状态
- **块管理**: 智能合并前后端进度信息
- **文件验证**: 检查文件完整性和一致性
- **错误处理**: 完善的错误恢复机制

## 📝 使用说明

1. **选择文件**: 点击上传区域或拖拽文件到指定区域
2. **自动分片**: 系统自动将大文件分割成2MB的块
3. **断点续传**: 网络中断或页面刷新后，重新选择文件自动从断点继续
4. **进度监控**: 实时查看每个文件的上传进度和状态
5. **错误处理**: 上传失败时会显示详细错误信息并自动重试
6. **网络状态**: 页面顶部显示当前网络连接状态

## ⚠️ 注意事项

1. **文件存储**: 当前使用文件系统存储，生产环境应使用数据库
2. **哈希算法**: 当前使用简化哈希算法，生产环境应使用专业的加密库
3. **进度清理**: 服务器重启后进度文件会自动加载
4. **并发限制**: 当前没有限制并发上传数量，生产环境应添加限制
5. **文件恢复**: 断点续传需要重新选择相同文件，无法自动恢复

## 🚧 扩展功能

可以考虑添加的功能：
- 文件预览和预览
- 上传速度限制和显示
- 文件压缩和优化
- 云存储集成（AWS S3、阿里云OSS等）
- 用户认证和权限控制
- 上传历史记录和统计
- 文件分享和下载链接
- 断点续传的自动恢复（无需重新选择文件）

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目！
