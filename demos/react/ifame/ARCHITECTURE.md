# 微前端架构设计文档

## 架构概述

本项目实现了一个基于Iframe的微前端架构，包含一个主应用（容器应用）和三个子应用，每个应用都可以独立开发、构建和部署。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    主应用 (Container App)                    │
│                    Port: 3000                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                Iframe Manager                       │   │
│  │              (应用生命周期管理)                       │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Communication Layer                    │   │
│  │            (跨应用通信管理)                          │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Global State Manager                   │   │
│  │              (全局状态管理)                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ postMessage API
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  子应用1     │     │  子应用2     │     │  子应用3     │
│ 用户管理     │     │ 产品管理     │     │ 数据分析     │
│ Port: 3001  │     │ Port: 3002  │     │ Port: 3003  │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 核心组件

### 1. 主应用 (Main App)
- **职责**: 应用容器、导航管理、全局状态协调
- **技术栈**: React + Webpack
- **端口**: 3000
- **功能**:
  - 应用注册和生命周期管理
  - 统一导航和路由控制
  - 全局状态管理
  - 跨应用通信协调

### 2. Iframe管理器 (IframeManager)
- **职责**: 子应用的加载、卸载和生命周期管理
- **核心功能**:
  - 应用注册和配置管理
  - 动态加载和卸载子应用
  - 响应式iframe尺寸调整
  - 应用状态监控

### 3. 通信层 (Communication)
- **职责**: 跨应用消息传递和事件处理
- **实现方式**: postMessage API
- **功能特性**:
  - 双向通信支持
  - 消息类型过滤
  - 响应式消息处理
  - 错误处理和超时机制

### 4. 全局状态管理器 (GlobalStateManager)
- **职责**: 应用间状态共享和同步
- **功能特性**:
  - 状态订阅和发布
  - 状态变更历史记录
  - 跨应用状态广播
  - 状态回滚支持

## 子应用架构

### 子应用1: 用户管理 (User Management)
- **端口**: 3001
- **功能**: 用户信息管理、权限控制、角色分配
- **技术栈**: React + Webpack
- **通信接口**:
  - 接收用户操作指令
  - 发送用户数据变更通知
  - 同步全局用户状态

### 子应用2: 产品管理 (Product Management)
- **端口**: 3002
- **功能**: 产品信息管理、库存控制、价格管理
- **技术栈**: React + Webpack
- **通信接口**:
  - 接收产品操作指令
  - 发送库存变更通知
  - 同步全局产品状态

### 子应用3: 数据分析 (Data Analytics)
- **端口**: 3003
- **功能**: 数据可视化、报表生成、趋势分析
- **技术栈**: React + Webpack
- **通信接口**:
  - 接收数据查询请求
  - 发送报表生成通知
  - 同步全局数据状态

## 通信协议

### 消息格式
```javascript
{
  id: "unique-message-id",
  type: "message-type",
  data: "message-data",
  timestamp: 1234567890,
  source: "app-id",
  target: "target-app-id",
  isResponse: false,
  originalId: "original-message-id"
}
```

### 消息类型
1. **appReady**: 应用就绪通知
2. **appLoaded**: 应用加载完成
3. **appUnload**: 应用卸载通知
4. **stateChange**: 状态变更通知
5. **heartbeat**: 心跳检测
6. **navigation**: 导航请求
7. **userAction**: 用户操作指令
8. **dataRefreshed**: 数据刷新通知

## 部署策略

### 开发环境
- 所有应用同时运行在不同端口
- 热重载支持
- 实时通信调试

### 生产环境
- 独立构建和部署
- CDN分发
- 版本控制和回滚

## 性能优化

### 1. 懒加载
- 子应用按需加载
- 资源预加载策略
- 缓存机制

### 2. 通信优化
- 消息批量处理
- 心跳机制优化
- 错误重试策略

### 3. 状态管理
- 状态变更合并
- 增量更新
- 内存泄漏防护

## 安全考虑

### 1. 跨域安全
- postMessage源验证
- 消息内容验证
- 权限控制

### 2. 数据安全
- 敏感信息过滤
- 传输加密
- 访问控制

## 扩展性设计

### 1. 新应用集成
- 标准化配置接口
- 插件化架构
- 动态注册机制

### 2. 技术栈支持
- 多框架兼容
- 版本管理
- 渐进式升级

## 监控和调试

### 1. 性能监控
- 加载时间统计
- 通信延迟监控
- 错误率统计

### 2. 调试工具
- 通信日志
- 状态快照
- 性能分析

## 最佳实践

### 1. 开发规范
- 统一的代码风格
- 组件设计原则
- 错误处理标准

### 2. 测试策略
- 单元测试覆盖
- 集成测试
- 端到端测试

### 3. 文档维护
- API文档
- 架构文档
- 部署文档

## 总结

本微前端架构通过Iframe技术实现了应用间的隔离和通信，具有以下优势：

1. **技术栈灵活性**: 支持不同技术栈的子应用
2. **独立部署**: 各应用可独立开发和部署
3. **性能优化**: 按需加载和缓存机制
4. **可扩展性**: 易于添加新的子应用
5. **维护性**: 清晰的架构分层和职责划分

这种架构特别适合大型企业应用，可以显著提高开发效率和系统可维护性。
